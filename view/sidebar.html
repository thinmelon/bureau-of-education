<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../style/common.css">
    <title>更多内容</title>
</head>
<body>
<div class="background">
    <div id="bar" class="bar"></div>
    <div id="sidebar" class="sidebar"></div>
    <div id="content" class="more-page-content"></div>
    <div class="more-page-index-img">
        <div id="more-page-index-text" class="more-page-index-text">
        </div>
    </div>
    <div id="cursor"></div>
    <div id="debug-message"></div>
</div>
</body>
<script type="application/javascript" src="../utility/assistant.js"></script>
<script type="application/javascript" src="../utility/async.js"></script>
<script type="application/javascript" src="../cms/cms.config.js"></script>
<script type="application/javascript" src="../cms/cms.api.js"></script>
<script type="application/javascript" src="../module/bar.module.js"></script>
<script type="application/javascript" src="../wrapper/bar.wrapper.js"></script>
<script type="application/javascript" src="../module/sidebar.module.js"></script>
<script type="application/javascript" src="../module/cursor.module.js"></script>
<script type="application/javascript" src="../module/more.module.js"></script>
<script type="application/javascript" src="../module/pager.module.js"></script>
<script type="application/javascript" src="../module/transfer.module.js"></script>
<script>
    function SidebarComponet() {
        SidebarModule.call(this);
    }

    function MoreComponent() {
        MoreModule.call(this);
    }

    function CursorComponent(bar, sidebar, more) {
        CursorModule.call(this);

        // 属性
        this.focusArea = 8;
        this.bar = bar;
        this.more = more;
        this.sidebar = sidebar;             //  注入侧边栏模块
        this.fileName = 'PG_MORE';

        // 方法
        this.moveX = function (direction) {
            this.focusOut();
            switch (this.focusArea) {
                case 4:             //  更多内容
                    this.more.moveX(direction);
                    break;
                case 5:             //  菜单栏
                    this.bar.moveX(direction, true);
                    break;
                case 8:             //  侧边栏
                    this.sidebar.moveX(direction);
                    this.more.focusPosX = 0;             //  定位在第一行第一项
                    this.more.focusPosY = 0;
                    this.more.resourceId = this.sidebar.sidebarItemArray[this.sidebar.focusPos].resourceId;
                    this.more.init(1, function () {
                    });
                    break;
                default:
                    break;
            }
            this.focusOn();
        };

        this.moveY = function (direction) {
            this.focusOut();
            switch (this.focusArea) {
                case 4:
                    if (-1 === this.more.moveY(direction)) {
                        if (direction < 0) {
                            this.focusArea = 8;
                        } else {
                            this.focusArea = 5;
                        }

                    }
                    break;
                case 5:
                    if (direction > 0) {
                        this.focusArea = 8;
                    }
                    break;
                case 8:         // 侧边栏
                    if (direction > 0) {
                        this.focusArea = 4;
                    } else {
                        this.focusArea = 5;
                    }
                    break;
                default:
                    break;
            }
            this.focusOn();
        };

        this.changePage = function (direction) {
            var that = this;

            this.more.changePage(direction, function () {
                that.focusOn();
            });
        };
    }

    function TransferComponent(cursor) {
        var that = this;

        TransferModule.call(this);
        // 属性
        this.cursor = cursor;

        // 方法
        this.doBack = function () {
            this.remove(this.cursor.fileName);
            window.location.href = this.cursor.more.backURL + this.package([]);
        };

        this.doSelect = function () {
            var
                postfix,
                params = {};

            this.remove(this.cursor.fileName);

            switch (this.cursor.focusArea) {
                case 4:
                    if (this.cursor.more.moreItemArray[this.cursor.more.focusPosY][this.cursor.more.focusPosX].flag === 0) {
                        params.PG_MORE = {
                            focusArea: this.cursor.focusArea,
                            focusPosX: this.cursor.more.focusPosX,
                            focusPosY: this.cursor.more.focusPosY,
                            resourceId: this.cursor.more.resourceId,
                            backURL: this.cursor.more.backURL,
                            pageIndex: this.cursor.more.pageIndex,
                            sidebarGroup: this.cursor.sidebar.sidebarGroup,
                            sidebarFocusPos: this.cursor.sidebar.focusPos,
                        };
                        params.PG_TEXT = {
                            resourceId: this.cursor.more.moreItemArray[this.cursor.more.focusPosY][this.cursor.more.focusPosX].id,
                            backURL: 'sidebar.html',
                        };
                        postfix = this.package(params);
                        window.location.href = 'detail.html' + postfix;
                    } else if (this.cursor.more.moreItemArray[this.cursor.more.focusPosY][this.cursor.more.focusPosX].flag === 1) {
                        params.VIDEO = {
                            backURL: this.backUrl(),
                            fileName: this.cursor.fileName,
                            focusArea: this.cursor.focusArea,
                            focusPosX: this.cursor.more.focusPosX,
                            focusPosY: this.cursor.more.focusPosY,
                            resourceId: this.cursor.more.resourceId,
                            morePageBackURL: this.cursor.more.backURL,
                            pageIndex: this.cursor.more.pageIndex,
                            sidebarGroup: this.cursor.sidebar.sidebarGroup,
                            sidebarFocusPos: this.cursor.sidebar.focusPos,
                            assertId: this.cursor.more.moreItemArray[this.cursor.more.focusPosY][this.cursor.more.focusPosX].assetid
                        };
                        postfix = this.package(params);
                        window.location.href = 'video.html' + postfix;
                    } else {

                    }
                    break;
                case 5:
                    this.cursor.bar.doSelect();
                    break;
                default:
                    break;
            }
        };

        this.onKeyDown = function (event) {
            var code = getKeyCode(event);

            switch (code) {
                case 'KEY_NUMBER1':
                    that.toggle();
                    return false;
                case 'KEY_UP':
                    that.cursor.moveY(-1);
                    return false;
                case 'KEY_DOWN':
                    that.cursor.moveY(1);
                    return false;
                case 'KEY_LEFT':
                    that.cursor.moveX(-1);
                    return false;
                case 'KEY_RIGHT':
                    that.cursor.moveX(1);
                    return false;
                case 'KEY_NUMBER3':
                case 'KEY_PAGE_UP':
                    that.cursor.changePage(-1);
                    return false;
                case 'KEY_NUMBER4':
                case 'KEY_PAGE_DOWN':
                    that.cursor.changePage(1);
                    return false;
                case 'KEY_SELECT':
                    that.doSelect();
                    return false;
                case 'KEY_EXIT':
                case 'KEY_BACK':
                    that.doBack();
                    return false;
                default:
                    break;
            }
        };
    }

    window.onload = function () {
        var
            barComponent = new BarComponent(),
            sidebarComponent = new SidebarComponet(),
            moreComponent = new MoreComponent(),
            cursorComponent = new CursorComponent(barComponent, sidebarComponent, moreComponent),
            transferComponent = new TransferComponent(cursorComponent);

        document.onkeydown = transferComponent.onKeyDown;

        transferComponent.init();
        barComponent.init();
        sidebarComponent.init();
//        if (moreComponent.resourceId === 0) {
        moreComponent.resourceId = sidebarComponent.sidebarItemArray[sidebarComponent.focusPos].resourceId;
//        }
        moreComponent.init(moreComponent.pageIndex, function () {
            cursorComponent.focusOn();
        });
    };
</script>
</html>